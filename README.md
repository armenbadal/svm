# Ստեկային վիրտուալ մեքենա

Սա մի մասն է «Ծրագրավորման լեզուների մշակում եւ իրականացում» դասընթացի։
Նպատակներից առաջինն է ապահեվել մի մեքենայի մի ամենապարզ, բայց ֆունկցիոնալ
մոդել, որի համար կոմպիլյատորը կոդ է գեներացնելու, մյուսը՝ ընդհանրապես 
վիրտուալ մեքենայի իրականացման ցուցադրումն է։

## Մեքենայի կառուցվածքը

Վիրտուալ մեքենան ունի երեք ռեգիստր. `IP` — հրամանների հաշվիչ, `SP` — ստեկի 
գագաթի ցուցիչ, `FP` — ստեկի ակտիվ կադրի ցուցիչ, և մի ընդհանուր հիշողություն՝
ծրագրի ու աշխատանքային ստեկի համար։

```Go
type Machine struct {
    IP, SP, FP int16
    memory []byte
}
```

Ծրագրի բինար ներկայացումը բեռնվում է հիշողության `0` հասցեից, ու `0` հասցեից
է սկսվում կատարումը։

Հրամանները երեք տեսակի են։ Այդ տեակը որոշվում է հրամանին բայթ֊կոդի առաջին
երկու բիթով։ Պարզագույնները առանց անմիջական արգումենտի հրամաններն են. դրանք
օգտագործում են ստեկի տվյալները և իրենց հաշվարկած արդյունքներն էլ գրում են
ստեկում։ Երկրորդը անմիջական թվային արգրումենտով հրամաններն են, օրինակ,
`PUSH 721`, որոնց 4 բայթանոց նշանով թիվ արգումենտը գրված է անմիջապես հրամանի
կոդից հետո։ Երրորդը անուղղակի հասցե արգումենտով հրամաններն են, որոնց երկու
բայթանոց արգումենտը գրված է հրամանի կոդից հետո։ Այդ արգումենտի առաջին երկու 
բիթով որոշվում է մեքենայի ռեգիստրը (_base_), իսկ մնացած բիթերով ներկայացվում
է նշանով արժեք (_displacement_)։ Վերջինս, գումարվելով նշված ռեգիստրի արժեքին, 
կազմում է բացարձակ հասցեն։

## Ասեմբլերի լեզուն

```text
Program   = { Line }.
Line      = [Label] [Operation] NewLines.
Label     = IDENT ':'.
Operation = IDENT [Argument].
NewLines  = '\n' { '\n' }.
Argument  = NUMBER
          | IDENT
          | '[' Register ('+'|'-') NUMBER ']'.
Register  = 'IP' | 'SP' | 'FP'.
```

## Բինար կոդի կառուցումը

Բինար կոդը կառուցելու համար է նախատեսված `bytecode` փաթեթի `Builder` օբյեկտը։ 
Այն թույլ է տալիս ծրագրի բինար կոդ կաոռցել ծրագրային եղանակով։ Օգտագործվում է
_ասեմբլերի_ կոսմից, նաև կարող է օգտագործել բարձր մակարդակի լեզվի կոմպիլյատորի 
կողմից;
