# Ստեկային վիրտուալ մեքենա

Սա մի մասն է «Ծրագրավորման լեզուների մշակում եւ իրականացում» դասընթացի։
Նպատակներից առաջինն է ապահովել մեքենայի մի ամենապարզ, բայց ֆունկցիոնալ
մոդել, որի համար կոմպիլյատորը կոդ է գեներացնելու, մյուսը՝ ընդհանրապես 
վիրտուալ մեքենայի իրականացման ցուցադրումն է։

## Մեքենայի կառուցվածքը

Վիրտուալ մեքենան ունի երեք ռեգիստր. `IP` — հրամանների հաշվիչ, `SP` — ստեկի 
գագաթի ցուցիչ, `FP` — ֆունկցիայի կանչի ակտիվ կադրի ցուցիչ, և մի ընդհանուր 
հիշողություն՝ ծրագրի ու աշխատանքային ստեկի համար։

```Go
type Machine struct {
    IP, SP, FP  int16
    memory      []byte
}
```

Ծրագրի բինար ներկայացումը բեռնվում է հիշողության `0` հասցեից, ու `0` հասցեից
է սկսվում կատարումը։

Հրամանները երեք տեսակի են։ Այդ տեսակը որոշվում է հրամանին բայթ֊կոդի առաջին
երկու բիթով։ Պարզագույնները առանց անմիջական արգումենտի հրամաններն են, օրինակ 
`ADD` կամ `EQ`. դրանք օգտագործում են ստեկի տվյալները և իրենց հաշվարկած 
արդյունքներն էլ գրում են ստեկում։ Երկրորդը անմիջական թվային արգրումենտով 
հրամաններն են, օրինակ, `PUSH 721`, որոնց 4 բայթանոց նշանով թիվ արգումենտը 
գրված է անմիջապես հրամանի կոդից հետո։ Երրորդը անուղղակի հասցե արգումենտով 
հրամաններն են, որոնց երկու բայթանոց արգումենտը գրված է հրամանի կոդից հետո։ 
Այդ արգումենտի առաջին երկու բիթով որոշվում է մեքենայի ռեգիստրը (_base_), իսկ 
մնացած բիթերով ներկայացվում է նշանով արժեք (_displacement_)։ Վերջինս, 
գումարվելով նշված ռեգիստրի արժեքին, կազմում է բացարձակ հասցեն։

## Ասեմբլերի լեզուն

```text
Program   = { Line }.
Line      = [Label] [Operation] NewLines.
Label     = IDENT ':'.
Operation = 'PUSH' (NUMBER | Indirect)
          | 'POP' Indirect
          | 'CALL' IDENT
          | 'JUMP' IDENT
          | 'JZ' IDENT
          | 'RET'
          | 'HALT'
          | 'INPUT'
          | 'PRINT'
          | 'ADD'
          | 'SUB'
          | 'MUL'
          | 'DIV'
          | 'MOD'
          | 'NEG'
          | 'AND'
          | 'OR'
          | 'NOT'
          | 'EQ'
          | 'NE'
          | 'LT'
          | 'LE'
          | 'GT'
          | 'GE'
          .
NewLines  = '\n' { '\n' }.
Indirect  = '[' Register ('+'|'-') NUMBER ']'.
Register  = 'IP' | 'SP' | 'FP'.
```

## Բինար կոդի կառուցումը

Բինար կոդը կառուցելու համար է նախատեսված `bytecode` փաթեթի `Builder` օբյեկտը։ 
Այն թույլ է տալիս բինար կոդ կառուցել ծրագրային եղանակով։ Օգտագործվում է
_ասեմբլերի_ կողմից, նաև կարող է օգտագործվել բարձր մակարդակի լեզվի կոմպիլյատորի 
կողմից։
